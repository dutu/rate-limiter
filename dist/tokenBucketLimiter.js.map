{"version":3,"file":"tokenBucketLimiter.js","names":["TokenBucketLimiter","bucketSize","tokensPerInterval","interval","stopped","tokens","tokensRemovedAt","Date","now","_isStopped","lastDrip","deltaMs","Math","max","tokensToAdd","min","floor","count","Error","dripTokens","tokensNeeded","undefined","ceil","RateLimiter"],"sources":["tokenBucketLimiter.js"],"sourcesContent":["import RateLimiter from './rateLimiter.js';\nexport class TokenBucketLimiter extends RateLimiter {\n  constructor({\n    bucketSize,\n    tokensPerInterval,\n    interval,\n    stopped = false\n  }) {\n    super({\n      tokensPerInterval,\n      interval,\n      stopped\n    });\n    this.bucketSize = bucketSize;\n    this.tokens = stopped ? 0 : this.bucketSize;\n    this.tokensRemovedAt = stopped ? [0] : [Date.now()];\n  }\n\n  dripTokens() {\n    if (this._isStopped) {\n      return;\n    }\n\n    const now = Date.now();\n    const lastDrip = this.tokensRemovedAt[0];\n    let deltaMs = Math.max(now - lastDrip, 0);\n    this.tokensRemovedAt = [now];\n    const tokensToAdd = deltaMs * (this.tokensPerInterval / this.interval);\n    this.tokens = Math.min(this.tokens + tokensToAdd, this.bucketSize);\n    return Math.floor(this.tokens);\n  }\n\n  getDelayForTokens(count = 1) {\n    if (count > this.bucketSize) {\n      throw new Error(`Cannot supply ${count} tokens at once (max is bucketSize = ${this.bucketSize}`);\n    }\n\n    this.dripTokens();\n    let tokensNeeded = count - this.tokens;\n\n    if (tokensNeeded <= 0) {\n      return 0;\n    }\n\n    if (this._isStopped) {\n      return undefined;\n    }\n\n    return Math.ceil(tokensNeeded * (this.interval / this.tokensPerInterval));\n  }\n\n  reset() {\n    this._isStopped = false;\n    this.tokens = this.bucketSize;\n    this.tokensRemovedAt = [Date.now()];\n    super.reset();\n  }\n\n}"],"mappings":";;;;;;;;;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;IACaA,kB;;;;;EACX,kCAKG;IAAA;;IAAA,IAJDC,UAIC,QAJDA,UAIC;IAAA,IAHDC,iBAGC,QAHDA,iBAGC;IAAA,IAFDC,QAEC,QAFDA,QAEC;IAAA,wBADDC,OACC;IAAA,IADDA,OACC,6BADS,KACT;;IAAA;;IACD,0BAAM;MACJF,iBAAiB,EAAjBA,iBADI;MAEJC,QAAQ,EAARA,QAFI;MAGJC,OAAO,EAAPA;IAHI,CAAN;IAKA,MAAKH,UAAL,GAAkBA,UAAlB;IACA,MAAKI,MAAL,GAAcD,OAAO,GAAG,CAAH,GAAO,MAAKH,UAAjC;IACA,MAAKK,eAAL,GAAuBF,OAAO,GAAG,CAAC,CAAD,CAAH,GAAS,CAACG,IAAI,CAACC,GAAL,EAAD,CAAvC;IARC;EASF;;;;WAED,sBAAa;MACX,IAAI,KAAKC,UAAT,EAAqB;QACnB;MACD;;MAED,IAAMD,GAAG,GAAGD,IAAI,CAACC,GAAL,EAAZ;MACA,IAAME,QAAQ,GAAG,KAAKJ,eAAL,CAAqB,CAArB,CAAjB;MACA,IAAIK,OAAO,GAAGC,IAAI,CAACC,GAAL,CAASL,GAAG,GAAGE,QAAf,EAAyB,CAAzB,CAAd;MACA,KAAKJ,eAAL,GAAuB,CAACE,GAAD,CAAvB;MACA,IAAMM,WAAW,GAAGH,OAAO,IAAI,KAAKT,iBAAL,GAAyB,KAAKC,QAAlC,CAA3B;MACA,KAAKE,MAAL,GAAcO,IAAI,CAACG,GAAL,CAAS,KAAKV,MAAL,GAAcS,WAAvB,EAAoC,KAAKb,UAAzC,CAAd;MACA,OAAOW,IAAI,CAACI,KAAL,CAAW,KAAKX,MAAhB,CAAP;IACD;;;WAED,6BAA6B;MAAA,IAAXY,KAAW,uEAAH,CAAG;;MAC3B,IAAIA,KAAK,GAAG,KAAKhB,UAAjB,EAA6B;QAC3B,MAAM,IAAIiB,KAAJ,yBAA2BD,KAA3B,kDAAwE,KAAKhB,UAA7E,EAAN;MACD;;MAED,KAAKkB,UAAL;MACA,IAAIC,YAAY,GAAGH,KAAK,GAAG,KAAKZ,MAAhC;;MAEA,IAAIe,YAAY,IAAI,CAApB,EAAuB;QACrB,OAAO,CAAP;MACD;;MAED,IAAI,KAAKX,UAAT,EAAqB;QACnB,OAAOY,SAAP;MACD;;MAED,OAAOT,IAAI,CAACU,IAAL,CAAUF,YAAY,IAAI,KAAKjB,QAAL,GAAgB,KAAKD,iBAAzB,CAAtB,CAAP;IACD;;;WAED,iBAAQ;MACN,KAAKO,UAAL,GAAkB,KAAlB;MACA,KAAKJ,MAAL,GAAc,KAAKJ,UAAnB;MACA,KAAKK,eAAL,GAAuB,CAACC,IAAI,CAACC,GAAL,EAAD,CAAvB;;MACA;IACD;;;;EAvDqCe,uB"}