{"version":3,"file":"rateLimiter.js","names":["RateLimiter","tokensPerInterval","interval","stopped","_isStopped","Error","tokensRemovedAt","awaitingRestart","Set","dripTokens","Math","floor","tokens","count","push","Date","now","Promise","resolve","add","delayMs","getDelayForTokens","setTimeout","awaitTokens","forEach","empty","tryRemoveTokens","getTokens"],"sources":["rateLimiter.js"],"sourcesContent":["export default class RateLimiter {\n  constructor({\n    tokensPerInterval,\n    interval,\n    stopped\n  }) {\n    this.tokensPerInterval = tokensPerInterval;\n    this._isStopped = stopped;\n\n    if (typeof interval === 'string') {\n      switch (interval) {\n        case 'sec':\n        case 'second':\n          {\n            this.interval = 1000;\n            break;\n          }\n\n        case 'min':\n        case 'minute':\n          {\n            this.interval = 1000 * 60;\n            break;\n          }\n\n        case 'hr':\n        case 'hour':\n          {\n            this.interval = 1000 * 60 * 60;\n            break;\n          }\n\n        case 'day':\n          {\n            this.interval = 1000 * 60 * 60 * 24;\n            break;\n          }\n\n        default:\n          throw new Error('Invalid interval ' + interval);\n      }\n    } else {\n      this.interval = interval;\n    }\n\n    this.tokensRemovedAt = [];\n    this.awaitingRestart = new Set();\n  }\n\n  dripTokens() {\n    throw new Error(`dripTokens() not implemented`);\n  }\n\n  getDelayForTokens() {\n    throw new Error(`getDelayForTokens() not implemented`);\n  }\n\n  getTokens() {\n    this.dripTokens();\n    return Math.floor(this.tokens);\n  }\n\n  tryRemoveTokens(count) {\n    this.dripTokens();\n\n    if (count > this.tokens) {\n      return false;\n    }\n\n    this.tokens -= count;\n    this.tokensRemovedAt.push([Date.now(), count]);\n    return true;\n  }\n\n  async awaitTokens(count = 1) {\n    if (this._isStopped) {\n      await new Promise(resolve => this.awaitingRestart.add(resolve));\n    }\n\n    let delayMs = this.getDelayForTokens(count);\n\n    if (delayMs === 0) {\n      return Math.floor(this.tokens);\n    }\n\n    await new Promise(resolve => setTimeout(() => resolve(), delayMs));\n    return this.awaitTokens(count);\n  }\n\n  reset() {\n    this.awaitingRestart.forEach(resolve => resolve());\n  }\n\n  stop(empty = true) {\n    this._isStopped = true;\n\n    if (empty) {\n      this.tryRemoveTokens(this.getTokens());\n    }\n  }\n\n  start() {\n    this._isStopped = false;\n  }\n\n  get isStopped() {\n    return this._isStopped;\n  }\n\n}"],"mappings":"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"}