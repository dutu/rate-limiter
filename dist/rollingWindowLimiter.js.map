{"version":3,"file":"rollingWindowLimiter.js","names":["RollingWindowLimiter","tokensPerInterval","interval","stopped","tokens","_isStopped","now","Date","tokensRemovedAt","length","shift","count","Error","dripTokens","tokensNeeded","undefined","newTokens","delayMs","RateLimiter"],"sources":["rollingWindowLimiter.js"],"sourcesContent":["import RateLimiter from './rateLimiter.js';\nexport class RollingWindowLimiter extends RateLimiter {\n  constructor({\n    tokensPerInterval,\n    interval,\n    stopped = false\n  }) {\n    super({\n      tokensPerInterval,\n      interval,\n      stopped\n    });\n    this.tokens = stopped ? 0 : this.tokensPerInterval;\n  }\n\n  dripTokens() {\n    if (this._isStopped) {\n      return;\n    }\n\n    const now = Date.now();\n\n    while (this.tokensRemovedAt.length > 0) {\n      if (this.tokensRemovedAt[0][0] + this.interval > now) {\n        break;\n      }\n\n      this.tokens += this.tokensRemovedAt[0][1];\n      this.tokensRemovedAt.shift();\n    }\n\n    if (this.tokens > this.tokensPerInterval) {\n      this.tokens = this.tokensPerInterval;\n    }\n\n    return this.tokens;\n  }\n\n  getDelayForTokens(count = 1) {\n    if (count > this.tokensPerInterval) {\n      throw new Error(`Cannot supply ${count} tokens at once (max is tokensPerInterval = ${this.tokensPerInterval}`);\n    }\n\n    this.dripTokens();\n    let tokensNeeded = count - this.tokens;\n\n    if (tokensNeeded <= 0) {\n      return 0;\n    }\n\n    if (this._isStopped) {\n      return undefined;\n    }\n\n    const now = Date.now();\n\n    for (const newTokens of this.tokensRemovedAt) {\n      tokensNeeded -= newTokens[1];\n\n      if (tokensNeeded <= 0) {\n        const delayMs = newTokens[0] + this.interval - now;\n        return delayMs;\n      }\n    }\n  }\n\n  reset() {\n    this._isStopped = false;\n    this.tokensRemovedAt = [];\n    this.tokens = this.tokensPerInterval;\n    super.reset();\n  }\n\n}"],"mappings":";;;;;;;;;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IACaA,oB;;;;;EACX,oCAIG;IAAA;;IAAA,IAHDC,iBAGC,QAHDA,iBAGC;IAAA,IAFDC,QAEC,QAFDA,QAEC;IAAA,wBADDC,OACC;IAAA,IADDA,OACC,6BADS,KACT;;IAAA;;IACD,0BAAM;MACJF,iBAAiB,EAAjBA,iBADI;MAEJC,QAAQ,EAARA,QAFI;MAGJC,OAAO,EAAPA;IAHI,CAAN;IAKA,MAAKC,MAAL,GAAcD,OAAO,GAAG,CAAH,GAAO,MAAKF,iBAAjC;IANC;EAOF;;;;WAED,sBAAa;MACX,IAAI,KAAKI,UAAT,EAAqB;QACnB;MACD;;MAED,IAAMC,GAAG,GAAGC,IAAI,CAACD,GAAL,EAAZ;;MAEA,OAAO,KAAKE,eAAL,CAAqBC,MAArB,GAA8B,CAArC,EAAwC;QACtC,IAAI,KAAKD,eAAL,CAAqB,CAArB,EAAwB,CAAxB,IAA6B,KAAKN,QAAlC,GAA6CI,GAAjD,EAAsD;UACpD;QACD;;QAED,KAAKF,MAAL,IAAe,KAAKI,eAAL,CAAqB,CAArB,EAAwB,CAAxB,CAAf;QACA,KAAKA,eAAL,CAAqBE,KAArB;MACD;;MAED,IAAI,KAAKN,MAAL,GAAc,KAAKH,iBAAvB,EAA0C;QACxC,KAAKG,MAAL,GAAc,KAAKH,iBAAnB;MACD;;MAED,OAAO,KAAKG,MAAZ;IACD;;;WAED,6BAA6B;MAAA,IAAXO,KAAW,uEAAH,CAAG;;MAC3B,IAAIA,KAAK,GAAG,KAAKV,iBAAjB,EAAoC;QAClC,MAAM,IAAIW,KAAJ,yBAA2BD,KAA3B,yDAA+E,KAAKV,iBAApF,EAAN;MACD;;MAED,KAAKY,UAAL;MACA,IAAIC,YAAY,GAAGH,KAAK,GAAG,KAAKP,MAAhC;;MAEA,IAAIU,YAAY,IAAI,CAApB,EAAuB;QACrB,OAAO,CAAP;MACD;;MAED,IAAI,KAAKT,UAAT,EAAqB;QACnB,OAAOU,SAAP;MACD;;MAED,IAAMT,GAAG,GAAGC,IAAI,CAACD,GAAL,EAAZ;;MAhB2B,2CAkBH,KAAKE,eAlBF;MAAA;;MAAA;QAkB3B,oDAA8C;UAAA,IAAnCQ,SAAmC;UAC5CF,YAAY,IAAIE,SAAS,CAAC,CAAD,CAAzB;;UAEA,IAAIF,YAAY,IAAI,CAApB,EAAuB;YACrB,IAAMG,OAAO,GAAGD,SAAS,CAAC,CAAD,CAAT,GAAe,KAAKd,QAApB,GAA+BI,GAA/C;YACA,OAAOW,OAAP;UACD;QACF;MAzB0B;QAAA;MAAA;QAAA;MAAA;IA0B5B;;;WAED,iBAAQ;MACN,KAAKZ,UAAL,GAAkB,KAAlB;MACA,KAAKG,eAAL,GAAuB,EAAvB;MACA,KAAKJ,MAAL,GAAc,KAAKH,iBAAnB;;MACA;IACD;;;;EAtEuCiB,uB"}