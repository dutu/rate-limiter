{"version":3,"sources":["../src/rollingWindowLimiter.mjs"],"names":["RateLimiter","constructor","interval","tokensPerInterval","now","Date","count","tokensNeeded","newTokens","delayMs"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,IAAA,YAAA,GAAA,sBAAA,CAAA,OAAA,CAAA,mBAAA,CAAA,CAAA;;;;;;;;IAEe,oB;;;;;AACbC,sCAA8C;AAAA;;AAAA,QAAjC,iBAAiC,QAAjC,iBAAiC;AAAA,QAAZC,QAAY,QAAZA,QAAY;;AAAA;;AAC5C,8BAAM;AAAEC,MAAAA,iBAAF,EAAEA,iBAAF;AAAqBD,MAAAA,QAAAA,EAAAA;AAArB,KAAN;AACA,UAAA,MAAA,GAAc,MAAd,iBAAA;AAF4C;AAG7C;;;;iCAEY;AACX,UAAME,GAAG,GAAGC,IAAI,CAAhB,GAAYA,EAAZ;;AACA,aAAO,KAAA,eAAA,CAAA,MAAA,GAAP,CAAA,EAAwC;AACtC,YAAI,KAAA,eAAA,CAAA,CAAA,EAAA,CAAA,IAA6B,KAA7B,QAAA,GAAJ,GAAA,EAAsD;AACpD;AACD;;AAED,aAAA,MAAA,IAAe,KAAA,eAAA,CAAA,CAAA,EAAf,CAAe,CAAf;AACA,aAAA,eAAA,CAAA,KAAA;AACD;;AAED,UAAI,KAAA,MAAA,GAAc,KAAlB,iBAAA,EAA0C;AACxC,aAAA,MAAA,GAAc,KAAd,iBAAA;AACD;;AAED,aAAO,KAAP,MAAA;AACD;;;wCAE4B;AAAA,UAAXC,KAAW,uEAAZ,CAAY;;AAC3B,UAAIA,KAAK,GAAG,KAAZ,iBAAA,EAAoC;AAClC,cAAM,IAAA,KAAA,yBAA2BA,KAA3B,yDAA+E,KAArF,iBAAM,EAAN;AACD;;AAED,WAAA,UAAA;AACA,UAAIC,YAAY,GAAGD,KAAK,GAAG,KAA3B,MAAA;;AACA,UAAIC,YAAY,IAAhB,CAAA,EAAuB;AACrB,eAAA,CAAA;AACD;;AAED,UAAMH,GAAG,GAAIC,IAAI,CAAjB,GAAaA,EAAb;;AAX2B,iDAYH,KAAxB,eAZ2B;AAAA;;AAAA;AAY3B,4DAA8C;AAAA,cAA9C,SAA8C;AAC5CE,UAAAA,YAAY,IAAIC,SAAS,CAAzBD,CAAyB,CAAzBA;;AACA,cAAIA,YAAY,IAAhB,CAAA,EAAuB;AACrB,gBAAME,OAAO,GAAGD,SAAS,CAATA,CAAS,CAATA,GAAe,KAAfA,QAAAA,GAAhB,GAAA;AACA,mBAAA,OAAA;AACD;AACF;AAlB0B;AAAA;AAAA;AAAA;AAAA;AAmB5B;;;;EA3C+CR,YAAnC,W","sourcesContent":["import RateLimiter from './rateLimiter.mjs'\r\n\r\nexport default class RollingWindowLimiter extends RateLimiter {\r\n  constructor ({ tokensPerInterval, interval }) {\r\n    super({ tokensPerInterval, interval })\r\n    this.tokens = this.tokensPerInterval\r\n  }\r\n\r\n  dripTokens() {\r\n    const now = Date.now()\r\n    while (this.tokensRemovedAt.length > 0) {\r\n      if (this.tokensRemovedAt[0][0] + this.interval > now) {\r\n        break\r\n      }\r\n\r\n      this.tokens += this.tokensRemovedAt[0][1]\r\n      this.tokensRemovedAt.shift()\r\n    }\r\n\r\n    if (this.tokens > this.tokensPerInterval) {\r\n      this.tokens = this.tokensPerInterval\r\n    }\r\n\r\n    return this.tokens\r\n  }\r\n\r\n  getDelayForTokens(count = 1) {\r\n    if (count > this.tokensPerInterval) {\r\n      throw new Error(`Cannot supply ${count} tokens at once (max is tokensPerInterval = ${this.tokensPerInterval}`)\r\n    }\r\n\r\n    this.dripTokens()\r\n    let tokensNeeded = count - this.tokens\r\n    if (tokensNeeded <= 0) {\r\n      return 0\r\n    }\r\n\r\n    const now  = Date.now()\r\n    for (const newTokens of this.tokensRemovedAt) {\r\n      tokensNeeded -= newTokens[1]\r\n      if (tokensNeeded <= 0) {\r\n        const delayMs = newTokens[0] + this.interval - now\r\n        return delayMs\r\n      }\r\n    }\r\n  }\r\n}\r\n"],"file":"rollingWindowLimiter.js"}